<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" type="image/png" href="https://www.melhorcomprar.com.br/images/lojas/cupom-desconto-skelt.webp">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
<title>Gest√£o de Notas Fiscais</title>
<style>
/* --- VARI√ÅVEIS E GERAL --- */
:root {
  --primary: #4f46e5;      /* √çndigo moderno */
  --primary-dark: #4338ca; /* √çndigo mais escuro para hover */
  --accent: #6366f1;       /* Acento suave */
  --bg: #f3f4f6;           /* Cinza muito claro, agrad√°vel aos olhos */
  --card: #ffffff;
  --text: #1f2937;         /* Cinza escuro, melhor que preto puro */
  --text-light: #6b7280;   /* Cinza m√©dio para labels */
  --border: #e5e7eb;
  --success: #10b981;
  --danger: #ef4444;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 12px;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg);
  margin: 0;
  color: var(--text);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* --- HEADER --- */
header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  padding: 24px;
  text-align: center;
  font-size: 26px;
  font-weight: 700;
  box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
  letter-spacing: -0.5px;
}

/* --- NAVEGA√á√ÉO --- */
nav {
  display: flex;
  justify-content: center;
  margin: 25px 0;
  gap: 12px;
  flex-wrap: wrap;
  padding: 0 16px;
}

nav button {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  border: 0;
  border-radius: 50px; /* Bot√µes arredondados modernos */
  cursor: pointer;
  background-color: #fff;
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
}

nav button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  color: var(--primary);
}

nav button.active {
  background-color: var(--primary);
  color: #fff;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

/* --- SE√á√ïES (CARDS) --- */
section {
  display: none;
  max-width: 1200px;
  margin: 0 auto 40px auto;
  padding: 30px;
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,0.5);
}

section.active {
  display: block;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- FORMUL√ÅRIOS --- */
label {
  display: block;
  margin-top: 16px;
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text);
  margin-bottom: 6px;
}

input, select, textarea {
  width: 100%;
  padding: 12px 16px;
  margin-top: 0;
  border-radius: 8px;
  border: 1px solid var(--border);
  background-color: #f9fafb;
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  color: var(--text);
  transition: all 0.2s;
  outline: none;
}

input:hover, select:hover, textarea:hover {
  background-color: #fff;
  border-color: #d1d5db;
}

input:focus, select:focus, textarea:focus {
  background-color: #fff;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* --- ESTILIZA√á√ÉO DO INPUT FILE --- */
input[type="file"] {
  padding: 6px;
  background: #fff;
}
input[type="file"]::file-selector-button {
  margin-right: 12px;
  padding: 8px 16px;
  border: none;
  background-color: #eef2ff; 
  color: var(--primary);    
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: background 0.2s, color 0.2s;
}
input[type="file"]::file-selector-button:hover {
  background-color: var(--primary);
  color: #fff;
}

/* --- BOT√ÉO ENVIAR (SEND) --- */
button.send {
  margin-top: 24px;
  padding: 14px;
  background: var(--primary);
  color: #fff;
  font-weight: 600;
  font-size: 16px;
  border: 0;
  border-radius: 8px;
  cursor: pointer;
  max-width: 100%;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
  transition: background 0.2s, transform 0.1s;
  box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
}

button.send:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

button.send:active {
  transform: translateY(1px);
}

button.send[disabled] {
  opacity: 0.7;
  cursor: not-allowed;
  background: var(--text-light);
}

/* --- ANIMA√á√ÉO DOTS --- */
.dots { display: inline-flex; gap: 4px; align-items: flex-end; visibility: hidden; height: 18px; }
.dots.active { visibility: visible; }
.dot { width: 6px; height: 6px; border-radius: 50%; background: #fff; animation: dot-bounce 0.9s infinite ease-in-out; }
.dot:nth-child(1) { animation-delay: 0s; }
.dot:nth-child(2) { animation-delay: 0.12s; }
.dot:nth-child(3) { animation-delay: 0.24s; }
@keyframes dot-bounce {
  0%, 100% { transform: translateY(0); opacity: 0.7; }
  50% { transform: translateY(-5px); opacity: 1; }
}

/* --- TABELA --- */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 24px;
  font-size: 14px;
  min-width: 900px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

th, td {
  padding: 14px 16px;
  text-align: left;
  vertical-align: middle;
  border-bottom: 1px solid var(--border);
}

th {
  background: #f8fafc;
  color: var(--text-light);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.05em;
  border-bottom: 2px solid var(--border);
}

th:nth-last-child(1), td:nth-last-child(1) { text-align: center; } 
th:nth-last-child(2), td:nth-last-child(2) { text-align: center; }

tr:last-child td { border-bottom: none; }
tr:nth-child(even) { background: #fff; }
tr:nth-child(odd) { background: #fafafa; }
tr:hover { background-color: #f1f5f9; transition: background 0.15s; }

/* A√ß√µes da tabela */
.actions button {
  margin: 0 4px;
  width: 32px;
  height: 32px;
  padding: 0;
  cursor: pointer;
  border-radius: 6px;
  border: 1px solid transparent;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.actions button.delete {
  background: #fee2e2;
  color: var(--danger);
}
.actions button.delete:hover { background: var(--danger); color: white; }

.actions button.email {
  background: #e0e7ff;
  color: var(--primary);
}
.actions button.email:hover { background: var(--primary); color: white; }

/* Links na tabela */
td a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
  padding: 4px 8px;
  background: #eef2ff;
  border-radius: 4px;
  font-size: 12px;
}
td a:hover { background: var(--primary); color: #fff; }

/* --- OBS BUBBLE --- */
.obs-bubble {
  display: none;
  position: absolute;
  background: #fff;
  border: 1px solid var(--border);
  padding: 16px;
  border-radius: 12px;
  width: 280px;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
  z-index: 1200;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }

.obs-bubble textarea {
  width: 100%;
  height: 100px;
  margin-bottom: 12px;
  resize: vertical;
}

.obs-bubble button {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}
.obs-bubble button:first-of-type { background: var(--primary); color: #fff; border-color: transparent; }

.obs-button-wrapper { position: relative; display: inline-block; }
.obs-indicator {
  position: absolute; top: -2px; right: -2px;
  width: 8px; height: 8px;
  background: var(--accent);
  border: 2px solid #fff;
  border-radius: 50%;
  display: none;
}
.obs-button-wrapper.has-text .obs-indicator { display: block; }

.obs-button {
  background: transparent; border: none; cursor: pointer; font-size: 16px; opacity: 0.7; transition: opacity 0.2s;
}
.obs-button:hover { opacity: 1; transform: scale(1.1); }

/* --- FEEDBACK TOAST --- */
#feedback {
  position: fixed;
  top: 24px; right: 24px;
  background: #1f2937;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  display: none;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  z-index: 1300;
  font-weight: 500;
  display: flex; align-items: center; gap: 8px;
}
#feedback::before { content: '‚úì'; display: inline-flex; align-items: center; justify-content: center; background: var(--success); color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 11px; margin-right: 8px; }

/* --- MODAL --- */
#deleteModal {
  display: none;
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(2px);
  justify-content: center; align-items: center;
  z-index: 1400;
}
#deleteModalContent {
  background: #fff;
  padding: 30px;
  border-radius: 16px;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}
#deleteModalContent p { font-size: 18px; font-weight: 600; margin-bottom: 24px; color: var(--text); }
#deleteModalContent button {
  margin: 0 6px; padding: 10px 20px; border-radius: 8px; border: 0; cursor: pointer; font-weight: 600; transition: transform 0.1s;
}
#deleteModalContent button:hover { transform: translateY(-1px); }
#confirmDelete { background: var(--danger) !important; color: white !important; box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); }

/* --- PAGINA√á√ÉO --- */
#paginationBar {
  display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-top: 20px; flex-wrap: wrap;
  padding-top: 20px; border-top: 1px solid var(--border);
}
.page-controls button {
  padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: #fff; color: var(--text); cursor: pointer; transition: all 0.2s;
}
.page-controls button:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
.page-controls button:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: transparent; }

.page-numbers button {
  width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center;
  border-radius: 6px; border: 0; background: transparent; cursor: pointer; color: var(--text); font-weight: 500;
}
.page-numbers button.active { background: var(--primary); color: #fff; }
.page-numbers button:hover:not(.active) { background: #eef2ff; color: var(--primary); }

#rowsPerPage { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); margin-left: 4px; margin-right: 4px; }

/* --- PREVIEW CONTAINER --- */
.preview-container {
  margin-top: 30px;
  padding: 20px;
  background: #eff6ff; /* Azul bem clarinho */
  border-left: 4px solid var(--primary);
  border-radius: 8px;
  position: relative;
}
.preview-container strong { color: var(--primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px; }
.preview-text {
  font-family: 'Courier New', Courier, monospace;
  margin-top: 0;
  font-size: 14px;
  color: #334155;
  line-height: 1.6;
}

/* √Årea de pesquisa */
#viewSection input[type="text"]#searchInput {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 12px center;
  padding-left: 40px;
}

@media (max-width: 900px) {
  table { font-size: 13px; min-width: 720px; }
  .page-numbers { max-width: 100%; overflow: auto; }
  section { padding: 20px; }
}
</style>
</head>
<body>

<header>Gest√£o de Notas Fiscais V2</header>

<nav>
    <button id="btnForm" class="active">Cadastrar NF</button>
    <button id="btnView">Visualizar NFs</button>
    <button id="btnEmails">Emails</button>
    <button id="btnManual">Manual COBERTURA</button>
</nav>

<section id="formSection" class="active">
    <form id="nfForm">
        <label for="razao">Raz√£o Social:</label>
        <input type="text" id="razao" required>

        <label for="nfVenda">N¬∫ NF Venda:</label>
        <input type="text" id="nfVenda" required>

        <label for="nfRemessa">N¬∫ NF Remessa (Fornecedor):</label>
        <input type="text" id="nfRemessa">

        <label for="nfCobertura">N¬∫ NF Cobertura:</label>
        <input type="text" id="nfCobertura">

        <label for="fabrica">F√°brica:</label>
        <select id="fabrica" required>
            <option value="">--Selecione--</option>
            <option value="ICNB">ICNB</option>
            <option value="UNA">UNA</option>
            <option value="NATURELLE">NATURELLE</option>
            <option value="DECOR">DECOR</option>
            <option value="AERCAMP">AERCAMP</option>
          <option value="LETS CARGO">LETS CARGO</option>
        </select>

        <label for="arquivo">Arquivo PDF:</label>
        <input type="file" id="arquivo" accept="application/pdf" required>

        <label for="observacao">Observa√ß√£o:</label>
        <input type="text" id="observacao" placeholder="Digite aqui uma observa√ß√£o">

        <button id="btnEnviarNF" type="button" class="send" onclick="enviarNF()">
          <span class="btn-text">Enviar NF</span>
          <span class="dots" aria-hidden="true">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </span>
        </button>

        <div id="previewContainer" class="preview-container" aria-live="polite">
            <strong>Texto de cobertura (visual):</strong>
            <p id="previewTextoCobertura" class="preview-text">
                Digite as informa√ß√µes acima para ver o texto aqui...
            </p>
        </div>
    </form>
</section>

<section id="viewSection">
    <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom: 20px;">
        <div style="flex:1; min-width:200px;">
            <label for="filtroFabrica">Filtrar por F√°brica:</label>
            <select id="filtroFabrica" onchange="aplicarFiltroPesquisa()">
                <option value="">Todas</option>
                <option value="ICNB">ICNB</option>
                <option value="UNA">UNA</option>
                <option value="NATURELLE">NATURELLE</option>
                <option value="DECOR">DECOR</option>
                <option value="AERCAMP">AERCAMP</option>
               <option value="LETS CARGO">LETS CARGO</option>
            </select>
        </div>

        <div style="flex:2; min-width:250px;">
            <label for="searchInput">Pesquisar:</label>
            <input type="text" id="searchInput" placeholder="Raz√£o, NF, F√°brica..." oninput="aplicarFiltroPesquisa()">
        </div>

        <div style="min-width:200px; display: flex; gap: 10px; padding-bottom: 1px;">
               <button onclick="carregarNFs()" style="padding: 12px; background: var(--primary); color: white; border:0; border-radius:8px; cursor:pointer; font-weight:600;">Atualizar</button>
               <button onclick="exportCSV()" style="padding: 12px; background: #fff; color: var(--text); border:1px solid var(--border); border-radius:8px; cursor:pointer; font-weight:600;">Exportar CSV</button>
        </div>
    </div>

    <table id="nfTable" aria-live="polite">
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Raz√£o Social</th>
                <th>N¬∫ NF Venda</th>
                <th>N¬∫ NF Remessa</th>
                <th>N¬∫ NF Cobertura</th>
                <th>F√°brica</th>
                <th>PDF</th>
                <th>Observa√ß√£o</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody><tr><td colspan="9" style="text-align:center;">Carregando...</td></tr></tbody>
    </table>

    <div id="paginationBar">
        <div class="page-controls">
            <button id="firstPageBtn" onclick="goToPage(1)">‚ü™</button>
            <button id="prevBtn" onclick="changePage(-1)">‚ü® Voltar</button>
        </div>

        <div class="page-numbers" id="pageNumbers"></div>

        <div class="page-controls">
            <button id="nextBtn" onclick="changePage(1)">Avan√ßar ‚ü©</button>
            <button id="lastPageBtn" onclick="goToLastPage()">‚ü´</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center; font-size: 13px;">
            <div>
                Mostrar
                <select id="rowsPerPage" onchange="changeRowsPerPage()">
                    <option value="10">10</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                / p√°g
            </div>
            <div id="showingInfo" style="white-space:nowrap; color: var(--text-light);"></div>
        </div>
    </div>
</section>

<section id="emailsSection">
    <form id="emailsForm">
        <label for="emailFabrica">F√°brica:</label>
        <select id="emailFabrica" required>
            <option value="">--Selecione--</option>
            <option value="ICNB">ICNB</option>
            <option value="UNA">UNA</option>
            <option value="NATURELLE">NATURELLE</option>
            <option value="DECOR">DECOR</option>
            <option value="AERCAMP">AERCAMP</option>
        </select>

        <label for="emailPara">E-mail(s) (separados por v√≠rgula):</label>
        <input type="text" id="emailPara" placeholder="ex: exemplo1@x.com,exemplo2@x.com">

        <button type="button" class="send" onclick="salvarEmails()">Salvar E-mails</button>
    </form>

    <table id="emailsTable">
        <thead><tr><th>F√°brica</th><th>E-mails</th></tr></thead>
        <tbody><tr><td colspan="2" style="text-align:center;">Carregando...</td></tr></tbody>
    </table>
</section>

<div id="obsBubble" class="obs-bubble" role="dialog" aria-modal="true">
    <textarea id="obsText" placeholder="Escreva a observa√ß√£o..."></textarea>
    <div style="text-align:right; gap: 8px; display: flex; justify-content: flex-end;">
        <button onclick="salvarObs()">Salvar</button>
        <button onclick="fecharObs()">Fechar</button>
    </div>
</div>

<div id="feedback">Opera√ß√£o realizada com sucesso!</div>

<div id="deleteModal" role="dialog" aria-modal="true">
    <div id="deleteModalContent">
        <p>Deseja realmente excluir esta NF?</p>
        <button id="confirmDelete">Sim, excluir</button>
        <button onclick="fecharModal()" style="background:#f3f4f6; color: var(--text);">Cancelar</button>
    </div>
</div>

<script>
/* Globals & lightweight cache */
const webAppURL = "https://script.google.com/macros/s/AKfycbyPdj_FtFywyV4Ey4b3-Q6YV3RcgXzsEUux6ceK23cdJTh71paHQ9HMD5Ts-pFOomUX/exec";
let allData = [], workingData = [];
let currentPage = 1;
let rowsPerPage = 10;
let obsId = null, deleteId = null;

/* Cache for last filter to avoid re-filtering same term */
let lastFilterKey = '';
let cachedFiltered = [];

/* UI refs */
const refs = {
  btnForm: document.getElementById('btnForm'),
  btnView: document.getElementById('btnView'),
  btnEmails: document.getElementById('btnEmails'),
  btnManual: document.getElementById('btnManual'),
  sections: {
    form: document.getElementById('formSection'),
    view: document.getElementById('viewSection'),
    emails: document.getElementById('emailsSection')
  },
  rowsPerPage: document.getElementById('rowsPerPage'),
  filtroFabrica: document.getElementById('filtroFabrica'),
  searchInput: document.getElementById('searchInput'),
  nfTableBody: document.querySelector('#nfTable tbody'),
  pageNumbers: document.getElementById('pageNumbers'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  firstPageBtn: document.getElementById('firstPageBtn'),
  lastPageBtn: document.getElementById('lastPageBtn'),
  showingInfo: document.getElementById('showingInfo'),
  feedback: document.getElementById('feedback'),
  emailsTableBody: document.querySelector('#emailsTable tbody'),
  obsBubble: document.getElementById('obsBubble'),
  obsText: document.getElementById('obsText'),
  deleteModal: document.getElementById('deleteModal'),
  confirmDelete: document.getElementById('confirmDelete'),
  // novos refs para a caixinha visual
  previewTextoCobertura: document.getElementById('previewTextoCobertura'),
  inputRazao: document.getElementById('razao'),
  inputNfVenda: document.getElementById('nfVenda'),
  inputNfRemessa: document.getElementById('nfRemessa'),
  // refs para o bot√£o que recebeu a anima√ß√£o
  btnEnviarNF: document.getElementById('btnEnviarNF')
};

/* Navigation */
function activateButton(btn){
  [refs.btnForm, refs.btnView, refs.btnEmails, refs.btnManual].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
refs.btnForm.addEventListener('click', ()=>{ activateButton(refs.btnForm); refs.sections.form.classList.add('active'); refs.sections.view.classList.remove('active'); refs.sections.emails.classList.remove('active'); });
refs.btnView.addEventListener('click', ()=>{ activateButton(refs.btnView); refs.sections.view.classList.add('active'); refs.sections.form.classList.remove('active'); refs.sections.emails.classList.remove('active'); carregarNFs(); });
refs.btnEmails.addEventListener('click', ()=>{ activateButton(refs.btnEmails); refs.sections.emails.classList.add('active'); refs.sections.form.classList.remove('active'); refs.sections.view.classList.remove('active'); carregarEmails(); });
refs.btnManual.addEventListener('click', ()=>{ window.open("https://xinzal.github.io/Manual-Emiss-o-de-NF-de-Cobertura-SKELT/", "_blank"); });

/* --- Fun√ß√µes para mostrar/esconder anima√ß√£o no bot√£o Enviar NF --- */
function showButtonLoading() {
  try {
    const btn = refs.btnEnviarNF;
    if(!btn) return;
    btn.setAttribute('disabled', 'disabled');
    const dots = btn.querySelector('.dots');
    if(dots) dots.classList.add('active');
  } catch(e) { console.error('Erro showButtonLoading', e); }
}
function hideButtonLoading() {
  try {
    const btn = refs.btnEnviarNF;
    if(!btn) return;
    btn.removeAttribute('disabled');
    const dots = btn.querySelector('.dots');
    if(dots) dots.classList.remove('active');
  } catch(e) { console.error('Erro hideButtonLoading', e); }
}

/* Enviar NF (mantive FileReader + POST) */
async function enviarNF(){
  const razao = document.getElementById('razao').value.trim();
  const nfVenda = document.getElementById('nfVenda').value.trim();
  const nfRemessa = document.getElementById('nfRemessa').value.trim();
  const nfCobertura = document.getElementById('nfCobertura').value.trim();
  const fabrica = document.getElementById('fabrica').value;
  const observacao = document.getElementById('observacao').value.trim();
  const arquivo = document.getElementById('arquivo').files[0];
  if(!fabrica){ alert('Selecione uma f√°brica antes de enviar.'); return; }
  if(!arquivo){ alert('Anexe o arquivo PDF antes de enviar.'); return; }

  // mostrar anima√ß√£o no bot√£o enquanto processa
  showButtonLoading();

  const reader = new FileReader();
  reader.onload = async () => {
    const pdfBase64 = reader.result;
    const pdfName = arquivo.name;
    const payload = { razao, nfVenda, nfRemessa, nfCobertura, fabrica, observacao, pdfBase64, pdfName };
    try{
      const res = await fetch(webAppURL, { method:'POST', body: JSON.stringify(payload)});
      const result = await res.json();
      if(result.status === 'success'){
        mostrarFeedback('NF cadastrada!');
        document.getElementById('nfForm').reset();
        carregarNFs();
        atualizarPreviewCobertura();
      } else {
        alert('Erro ao cadastrar NF.');
      }
    }catch(e){
      console.error(e);
      alert('Erro de conex√£o.');
    } finally {
      // sempre esconder a anima√ß√£o ao final (sucesso ou erro)
      hideButtonLoading();
    }
  };
  reader.onerror = function(e){
    console.error('Erro ao ler arquivo', e);
    alert('Erro ao ler o arquivo selecionado.');
    hideButtonLoading();
  };
  reader.readAsDataURL(arquivo);
}

/* Carregar NFs do servidor */
async function carregarNFs(){
  try{
    const res = await fetch(webAppURL + '?action=get');
    allData = await res.json();
    if(!Array.isArray(allData)) allData = [];
    allData.sort((a,b)=> (new Date(b.dataHora||0) - new Date(a.dataHora||0)));
    // reset cache when data changes
    lastFilterKey = '';
    aplicarFiltroPesquisa();
  }catch(err){
    console.error(err);
    allData = [];
    aplicarFiltroPesquisa();
  }
}

/* Filtrar + pesquisar (√∫nica passagem por item) */
function aplicarFiltroPesquisa(){
  const filtro = refs.filtroFabrica.value || '';
  const termo = (refs.searchInput.value || '').toLowerCase().trim();
  const key = filtro + '|' + termo;
  if(key === lastFilterKey){
    // j√° temos o resultado em cachedFiltered
    workingData = cachedFiltered;
  } else {
    // filtrar em uma √∫nica passagem (redu√ß√£o de loops)
    const tmp = [];
    for(let i=0, L=allData.length;i<L;i++){
      const r = allData[i];
      if(filtro && String(r.fabrica || '') !== filtro) continue;
      if(!termo){ tmp.push(r); continue; }
      
      // busca combinada -> ADICIONADO "nfCobertura" AQUI
      const combined = (
        String(r.razao||'') + '|' + 
        String(r.nfVenda||'') + '|' + 
        String(r.nfRemessa||'') + '|' + 
        String(r.nfCobertura||'') + '|' + 
        String(r.fabrica||'') + '|' + 
        String(r.observacao||'')
      ).toLowerCase();
      
      if(combined.indexOf(termo) !== -1) tmp.push(r);
    }
    cachedFiltered = tmp;
    lastFilterKey = key;
    workingData = tmp;
  }
  currentPage = 1;
  renderTabela();
}

/* Render tabela ‚Äî usa DocumentFragment e s√≥ substitui tbody uma vez */
function renderTabela(){
  const tbody = refs.nfTableBody;
  // se muitos itens, s√≥ renderiza a p√°gina atual (lazy rendering)
  rowsPerPage = parseInt(refs.rowsPerPage.value,10) || 10;
  const totalItems = workingData.length;
  const totalPages = Math.max(1, Math.ceil(totalItems/rowsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*rowsPerPage;
  const end = Math.min(totalItems, start+rowsPerPage);
  const pageData = workingData.slice(start, end);

  // construir fragmento
  const frag = document.createDocumentFragment();
  if(pageData.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 9;
    td.style.textAlign = 'center';
    td.textContent = totalItems === 0 ? 'Nenhuma NF encontrada.' : 'Nenhuma NF nesta p√°gina.';
    tr.appendChild(td);
    frag.appendChild(tr);
  } else {
    for(const r of pageData){
      const hasObs = String(r.observacao || '').trim() !== '';
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.textContent = r.dataHora ? new Date(r.dataHora).toLocaleString() : '-';
      tr.appendChild(tdDate);

      const tdRaz = document.createElement('td');
      tdRaz.contentEditable = "true";
      tdRaz.onblur = function(){ atualizarCampo(r.id,'razao',this.innerText); };
      tdRaz.innerHTML = escapeHtml(r.razao || '');
      tr.appendChild(tdRaz);

      const tdVenda = document.createElement('td');
      tdVenda.contentEditable = "true";
      tdVenda.onblur = function(){ atualizarCampo(r.id,'nfVenda',this.innerText); };
      tdVenda.innerHTML = escapeHtml(r.nfVenda || '');
      tr.appendChild(tdVenda);

      const tdRem = document.createElement('td');
      tdRem.contentEditable = "true";
      tdRem.onblur = function(){ atualizarCampo(r.id,'nfRemessa',this.innerText); };
      tdRem.innerHTML = escapeHtml(r.nfRemessa || '');
      tr.appendChild(tdRem);

      const tdCob = document.createElement('td');
      tdCob.contentEditable = "true";
      tdCob.onblur = function(){ atualizarCampo(r.id,'nfCobertura',this.innerText); };
      tdCob.innerHTML = escapeHtml(r.nfCobertura || '');
      tr.appendChild(tdCob);

      const tdFab = document.createElement('td');
      tdFab.contentEditable = "true";
      tdFab.onblur = function(){ atualizarCampo(r.id,'fabrica',this.innerText); };
      tdFab.innerHTML = escapeHtml(r.fabrica || '');
      tr.appendChild(tdFab);

      const tdPdf = document.createElement('td');
      tdPdf.innerHTML = r.pdfLink ? `<a href="${r.pdfLink}" target="_blank" rel="noopener">Abrir PDF</a>` : '‚Äî';
      tr.appendChild(tdPdf);

      const tdObs = document.createElement('td');
      const obsWrap = document.createElement('div');
      obsWrap.className = 'obs-button-wrapper' + (hasObs? ' has-text': '');
      obsWrap.title = escapeHtml((r.observacao||'').split('\n')[0]||'');
      const btn = document.createElement('button');
      btn.className = 'obs-button';
      btn.textContent = 'üí¨';
      // manter compatibilidade com abrirObs(id,this)
      btn.onclick = function(e){ abrirObs(r.id, this); };
      const span = document.createElement('span');
      span.className = 'obs-indicator';
      obsWrap.appendChild(btn);
      obsWrap.appendChild(span);
      tdObs.appendChild(obsWrap);
      tr.appendChild(tdObs);

      const tdActions = document.createElement('td');
      tdActions.className = 'actions';
      const delBtn = document.createElement('button');
      delBtn.className = 'delete';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.onclick = function(){ abrirModal(r.id); };
      const emailBtn = document.createElement('button');
      emailBtn.className = 'email';
      emailBtn.textContent = '‚úâÔ∏è';
      emailBtn.onclick = function(){ enviarEmailNF(r.id); };
      tdActions.appendChild(delBtn);
      tdActions.appendChild(emailBtn);
      tr.appendChild(tdActions);

      frag.appendChild(tr);
    }
  }

  // substituir tbody de uma vez s√≥ (ap√™ndice m√≠nimo de opera√ß√µes DOM)
  tbody.innerHTML = '';
  tbody.appendChild(frag);

  updatePaginationUI(totalItems, totalPages, start+1, end);
}

/* Atualiza UI da pagina√ß√£o (apenas 1 opera√ß√£o por campo) */
function updatePaginationUI(totalItems, totalPages, startIndex = 0, endIndex = 0){
  refs.pageNumbers.innerHTML = '';
  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - Math.floor(maxButtons/2));
  let endPage = startPage + maxButtons - 1;
  if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxButtons + 1); }

  if(startPage > 1){
    const b1 = document.createElement('button'); b1.textContent = '1'; b1.onclick = ()=>goToPage(1); refs.pageNumbers.appendChild(b1);
    if(startPage > 2){ const e = document.createElement('button'); e.textContent = '...'; e.disabled = true; refs.pageNumbers.appendChild(e); }
  }
  for(let p=startPage;p<=endPage;p++){
    const b = document.createElement('button'); b.textContent = p; if(p===currentPage) b.classList.add('active'); b.onclick = ()=>goToPage(p); refs.pageNumbers.appendChild(b);
  }
  if(endPage < totalPages){
    if(endPage < totalPages -1){ const e = document.createElement('button'); e.textContent = '...'; e.disabled = true; refs.pageNumbers.appendChild(e); }
    const bl = document.createElement('button'); bl.textContent = totalPages; bl.onclick = ()=>goToPage(totalPages); refs.pageNumbers.appendChild(bl);
  }

  refs.prevBtn.disabled = currentPage <= 1;
  refs.nextBtn.disabled = currentPage >= totalPages;
  refs.firstPageBtn.disabled = currentPage <= 1;
  refs.lastPageBtn.disabled = currentPage >= totalPages;

  const info = totalItems === 0 ? 'Mostrando 0 de 0' : `Mostrando ${startIndex}‚Äì${Math.min(totalItems, endIndex)} de ${totalItems}`;
  refs.showingInfo.innerText = info;
}

/* Pagina√ß√£o helpers */
function changePage(dir){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = Math.min(totalPages, Math.max(1, currentPage + dir)); renderTabela(); }
function goToPage(n){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = Math.min(totalPages, Math.max(1, n)); renderTabela(); }
function goToLastPage(){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = totalPages; renderTabela(); }
function changeRowsPerPage(){ rowsPerPage = parseInt(refs.rowsPerPage.value,10); currentPage = 1; renderTabela(); }

/* Observa√ß√µes */
function abrirObs(id, btn){
  obsId = id;
  const bubble = refs.obsBubble;
  const nf = allData.find(x=>x.id===id) || {};
  refs.obsText.value = nf.observacao || '';
  bubble.style.display = 'block';
  const rect = btn.getBoundingClientRect();
  bubble.style.left = (rect.left + window.scrollX - 240) + 'px'; // Ajustado para n√£o sair da tela
  bubble.style.top = (rect.bottom + window.scrollY + 8) + 'px';
}
function fecharObs(){ refs.obsBubble.style.display = 'none'; }
async function salvarObs(){
  const texto = refs.obsText.value;
  if(!obsId) return fecharObs();
  try{
    await fetch(`${webAppURL}?action=update&id=${obsId}&observacao=${encodeURIComponent(texto)}`);
    fecharObs(); mostrarFeedback('Observa√ß√£o salva!'); await carregarNFs();
  }catch(err){ console.error(err); alert('Erro ao salvar observa√ß√£o'); }
}

/* Delete modal */
function abrirModal(id){ deleteId = id; refs.deleteModal.style.display = 'flex'; }
function fecharModal(){ deleteId = null; refs.deleteModal.style.display = 'none'; }
refs.confirmDelete.addEventListener('click', async ()=>{
  if(!deleteId) return fecharModal();
  try{ await fetch(`${webAppURL}?action=delete&id=${deleteId}`); fecharModal(); mostrarFeedback('NF exclu√≠da!'); await carregarNFs(); }
  catch(err){ console.error(err); alert('Erro ao excluir'); }
});

/* Atualizar campo inline */
async function atualizarCampo(id, campo, valor){
  valor = String(valor || '').trim();
  try{ await fetch(`${webAppURL}?action=update&id=${id}&${campo}=${encodeURIComponent(valor)}`); }
  catch(err){ console.error(err); }
}

/* Enviar e-mail por NF */
async function enviarEmailNF(id){
  const nf = allData.find(x=>x.id===id);
  if(!nf){ alert('NF n√£o encontrada'); return; }
  try{
    const res = await fetch(`${webAppURL}?action=getEmails&fabrica=${encodeURIComponent(nf.fabrica)}`);
    const emails = await res.json();
    if(!emails.emailPara){ alert('Nenhum e-mail cadastrado para esta f√°brica!'); return; }
    const subject = `Nota de cobertura referente a nota (${nf.nfVenda||''}/${nf.nfRemessa||''}) fornecedor (${nf.razao||''}) X ${nf.fabrica||''}`;
    const body = `Nota de cobertura referente a nota (${nf.nfVenda||''}/${nf.nfRemessa||''}) fornecedor (${nf.razao||''}) X ${nf.fabrica||''}\nPDF: ${nf.pdfLink||'N√£o dispon√≠vel'}`;
    await fetch(webAppURL, { method:'POST', body: JSON.stringify({ action:'sendEmail', to:emails.emailPara, cc:emails.emailCC, subject, body }) });
    mostrarFeedback('E-mail enviado!');
  }catch(err){ console.error(err); alert('Erro ao enviar e-mail'); }
}

/* E-mails (cadastro/listagem) */
async function salvarEmails(){
  const fabrica = document.getElementById('emailFabrica').value;
  const emailPara = document.getElementById('emailPara').value;
  if(!fabrica || !emailPara) return alert('Preencha todos os campos!');
  try{
    const res = await fetch(webAppURL, { method:'POST', body: JSON.stringify({ action:'saveEmails', fabrica, emailPara }) });
    const result = await res.json();
    if(result.status === 'success'){ mostrarFeedback('E-mail salvo!'); document.getElementById('emailsForm').reset(); carregarEmails(); }
    else alert('Erro ao salvar e-mail');
  }catch(err){ console.error(err); alert('Erro ao salvar e-mail'); }
}
async function carregarEmails(){
  try{
    const res = await fetch(webAppURL + '?action=getEmailsAll');
    const data = await res.json();
    const tbody = refs.emailsTableBody;
    tbody.innerHTML = '';
    if(!Array.isArray(data) || data.length === 0){
      const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=2; td.style.textAlign='center'; td.textContent='Nenhum e-mail cadastrado.'; tr.appendChild(td); tbody.appendChild(tr);
    } else {
      const frag = document.createDocumentFragment();
      for(const r of data){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = r.fabrica||''; const td2 = document.createElement('td'); td2.textContent = r.emailPara||'';
        tr.appendChild(td1); tr.appendChild(td2); frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }
  }catch(err){ console.error(err); }
}

/* Export CSV (CORRIGIDO PARA EXCEL BRASILEIRO E UTF-8) */
function exportCSV(){
  const headers = ['dataHora','razao','nfVenda','nfRemessa','nfCobertura','fabrica','pdfLink','observacao'];
  // Usar ; como separador
  const rows = [headers.join(';')];
  allData.forEach(r=>{ 
      const line = headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(';'); 
      rows.push(line); 
  });
  const csv = rows.join('\n');
  
  // Adiciona BOM (\uFEFF) para o Excel reconhecer os acentos
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'notas_fiscais.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Feedback */
function mostrarFeedback(txt){
  const f = refs.feedback; 
  // Pequeno hack para garantir que o texto seja atualizado
  f.innerHTML = txt; 
  f.style.display = 'flex';
  setTimeout(()=>{ f.style.display = 'none'; }, 2200);
}

/* util */
function escapeHtml(text){
  if(!text) return '';
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* --- FUN√á√ÉO ADICIONADA: atualiza a caixinha visual conforme digita (N√ÉO salva) --- */
function atualizarPreviewCobertura(){
  const razao = (refs.inputRazao && refs.inputRazao.value.trim()) || '';
  const nfVenda = (refs.inputNfVenda && refs.inputNfVenda.value.trim()) || '';
  const nfRemessa = (refs.inputNfRemessa && refs.inputNfRemessa.value.trim()) || '';

  // Monta o texto seguindo o padr√£o que voc√™ pediu (apenas visual)
  const texto = `segue NF de cobertura referente a NF (N¬∫ NF Venda: ${nfVenda || '...'}) - (Raz√£o Social: ${razao || '...'}) NF de remessa (N¬∫ NF Remessa (Fornecedor): ${nfRemessa || '...'})`;

  if(refs.previewTextoCobertura){
    refs.previewTextoCobertura.textContent = texto;
  }
}

/* Inicializa√ß√£o (evento √∫nico) */
window.addEventListener('load', ()=>{
  refs.rowsPerPage.value = refs.rowsPerPage.value || '10';
  rowsPerPage = parseInt(refs.rowsPerPage.value,10);
  // carrega NFs e emails s√≥ quando necess√°rio: aqui pre-popular para primeira abertura
  carregarNFs();
  carregarEmails();
  // otimiza√ß√£o adicional: manter cache e listeners j√° configurados (fun√ß√µes inline mantidas para compatibilidade)

  // listeners para a caixinha visual (apenas visual, n√£o salva)
  try{
    if(refs.inputRazao) refs.inputRazao.addEventListener('input', atualizarPreviewCobertura);
    if(refs.inputNfVenda) refs.inputNfVenda.addEventListener('input', atualizarPreviewCobertura);
    if(refs.inputNfRemessa) refs.inputNfRemessa.addEventListener('input', atualizarPreviewCobertura);
    // atualizar uma vez ao carregar
    atualizarPreviewCobertura();
  }catch(e){ console.error('Erro ao inicializar preview:', e); }
});
</script>

</body>
</html>
