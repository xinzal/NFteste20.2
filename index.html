<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gestão de Notas Fiscais</title>
<style>
/* Paleta atualizada: azul nos botões/menus, resto original */
:root {
  --primary: #003c8f;   /* azul escuro para botões ativos e hover */
  --accent: #0277bd;    /* azul médio para botões normais */
  --bg: #f4f0f8;        /* cor original do fundo */
  --card: #fff;          /* cor original dos cards */
  --text: #333;          /* cor original do texto */
}

*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background-color:var(--bg);margin:0;color:var(--text)}
header{background-color:var(--primary);color:#fff;padding:20px;text-align:center;font-size:24px;font-weight:700;border-bottom:4px solid rgba(0,0,0,0.03)}
nav{display:flex;justify-content:center;margin:20px 0;gap:12px;flex-wrap:wrap;padding:0 12px}
nav button{padding:10px 18px;font-size:15px;border:0;border-radius:8px;cursor:pointer;background-color:var(--accent);color:#fff;transition:transform .12s ease}
nav button.active,nav button:hover{background-color:var(--primary);transform:translateY(-1px)}

section{display:none;max-width:1200px;margin:12px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);overflow:auto}
section.active{display:block}

label{display:block;margin-top:12px;font-weight:700;color:rgba(75,0,130,0.95)}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 6px rgba(0,60,143,0.12)}

button.send{margin-top:18px;padding:12px;background:var(--primary);color:#fff;font-weight:700;border:0;border-radius:6px;cursor:pointer;max-width:320px;width:100%}

table{width:100%;border-collapse:collapse;margin-top:18px;font-size:14px;min-width:900px}
th,td{border:1px solid #e6dff1;padding:10px;text-align:center;vertical-align:middle}
th{background:var(--primary);color:#fff;font-weight:600}
tr:nth-child(even){background:#fbf6fd}
tr:hover{background:#f0e0fb}

.actions button{margin:0 4px;padding:6px 10px;cursor:pointer;border-radius:6px;border:0}
.actions button.delete{background:#ff6b6b;color:#fff}
.actions button.email{background:var(--primary);color:#fff}

.obs-bubble{display:none;position:absolute;background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;width:260px;box-shadow:0 10px 28px rgba(0,0,0,0.12);z-index:1200;animation:fadeIn .18s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.obs-bubble textarea{width:100%;height:80px;margin-bottom:8px}
.obs-button-wrapper{position:relative;display:inline-block}
.obs-indicator{position:absolute;top:-4px;right:-6px;width:10px;height:10px;background:purple;border-radius:50%;display:none}
.obs-button-wrapper.has-text .obs-indicator{display:block}

#feedback{position:fixed;top:18px;right:18px;background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;display:none;box-shadow:0 10px 28px rgba(0,0,0,0.14);z-index:1300}
#deleteModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:1400}
#deleteModalContent{background:#fff;padding:18px;border-radius:10px;max-width:420px;text-align:center;box-shadow:0 12px 36px rgba(0,0,0,0.18)}
#deleteModalContent button{margin:8px;padding:8px 14px;border-radius:6px;border:0;cursor:pointer}

#paginationBar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap}
.page-controls{display:flex;align-items:center;gap:8px}
.page-controls button{padding:6px 10px;border-radius:6px;border:0;background:var(--primary);color:#fff;cursor:pointer}
.page-controls button:disabled{background:#ddd;color:#666;cursor:not-allowed}
.page-numbers{display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:60%}
.page-numbers button{padding:6px 10px;border-radius:6px;border:0;background:#eee;cursor:pointer}
.page-numbers button.active{background:var(--primary);color:#fff;font-weight:600}
#rowsPerPage{padding:6px;border-radius:6px}
@media (max-width:900px){table{font-size:13px;min-width:720px}.page-numbers{max-width:100%;overflow:auto}}
</style>
</head>
<body>

<header>Gestão de Notas Fiscais</header>

<nav>
    <button id="btnForm" class="active">Cadastrar NF</button>
    <button id="btnView">Visualizar NFs</button>
    <button id="btnEmails">Emails</button>
    <button id="btnManual">Manual COBERTURA</button>
</nav>

<!-- Cadastrar NF -->
<section id="formSection" class="active">
    <form id="nfForm">
        <label for="razao">Razão Social:</label>
        <input type="text" id="razao" required>

        <label for="nfVenda">Nº NF Venda:</label>
        <input type="text" id="nfVenda" required>

        <label for="nfRemessa">Nº NF Remessa (Fornecedor):</label>
        <input type="text" id="nfRemessa">

        <label for="nfCobertura">Nº NF Cobertura:</label>
        <input type="text" id="nfCobertura">

        <label for="fabrica">Fábrica:</label>
        <select id="fabrica" required>
            <option value="">--Selecione--</option>
            <option value="ICNB">ICNB</option>
            <option value="UNA">UNA</option>
            <option value="NATURELLE">NATURELLE</option>
            <option value="DECOR">DECOR</option>
            <option value="AERCAMP">AERCAMP</option>
        </select>

        <label for="arquivo">Arquivo PDF:</label>
        <input type="file" id="arquivo" accept="application/pdf" required>

        <label for="observacao">Observação:</label>
        <input type="text" id="observacao" placeholder="Digite aqui uma observação">

        <button type="button" class="send" onclick="enviarNF()">Enviar NF</button>
    </form>
</section>

<!-- Visualizar NFs -->
<section id="viewSection">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
            <label for="filtroFabrica">Filtrar por Fábrica:</label>
            <select id="filtroFabrica" onchange="aplicarFiltroPesquisa()">
                <option value="">Todas</option>
                <option value="ICNB">ICNB</option>
                <option value="UNA">UNA</option>
                <option value="NATURELLE">NATURELLE</option>
                <option value="DECOR">DECOR</option>
                <option value="AERCAMP">AERCAMP</option>
            </select>
        </div>

        <div style="flex:2; min-width:220px;">
            <label for="searchInput">Pesquisar:</label>
            <input type="text" id="searchInput" placeholder="Pesquise razão, NF, fábrica..." oninput="aplicarFiltroPesquisa()">
        </div>

        <div style="min-width:220px;">
            <label>&nbsp;</label>
            <div style="display:flex; gap:8px;">
                <button onclick="carregarNFs()">Atualizar</button>
                <button onclick="exportCSV()">Exportar CSV</button>
            </div>
        </div>
    </div>

    <table id="nfTable" aria-live="polite">
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Razão Social</th>
                <th>Nº NF Venda</th>
                <th>Nº NF Remessa</th>
                <th>Nº NF Cobertura</th>
                <th>Fábrica</th>
                <th>PDF</th>
                <th>Observação</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody><tr><td colspan="9" style="text-align:center;">Carregando...</td></tr></tbody>
    </table>

    <div id="paginationBar">
        <div class="page-controls">
            <button id="firstPageBtn" onclick="goToPage(1)">⟪ Primeiro</button>
            <button id="prevBtn" onclick="changePage(-1)">⟨ Voltar</button>
        </div>

        <div class="page-numbers" id="pageNumbers"></div>

        <div class="page-controls">
            <button id="nextBtn" onclick="changePage(1)">Avançar ⟩</button>
            <button id="lastPageBtn" onclick="goToLastPage()">Último ⟫</button>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
            <div>
                Mostrar
                <select id="rowsPerPage" onchange="changeRowsPerPage()">
                    <option value="10">10</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                por página
            </div>
            <div id="showingInfo" style="white-space:nowrap; font-size:13px; color:#333;"></div>
        </div>
    </div>
</section>

<!-- Emails -->
<section id="emailsSection">
    <form id="emailsForm">
        <label for="emailFabrica">Fábrica:</label>
        <select id="emailFabrica" required>
            <option value="">--Selecione--</option>
            <option value="ICNB">ICNB</option>
            <option value="UNA">UNA</option>
            <option value="NATURELLE">NATURELLE</option>
            <option value="DECOR">DECOR</option>
            <option value="AERCAMP">AERCAMP</option>
        </select>

        <label for="emailPara">E-mail(s) (separados por vírgula):</label>
        <input type="text" id="emailPara" placeholder="ex: exemplo1@x.com,exemplo2@x.com">

        <button type="button" class="send" onclick="salvarEmails()">Salvar E-mails</button>
    </form>

    <table id="emailsTable">
        <thead><tr><th>Fábrica</th><th>E-mails</th></tr></thead>
        <tbody><tr><td colspan="2" style="text-align:center;">Carregando...</td></tr></tbody>
    </table>
</section>

<!-- Obs bubble -->
<div id="obsBubble" class="obs-bubble" role="dialog" aria-modal="true">
    <textarea id="obsText" placeholder="Escreva a observação..."></textarea>
    <div style="text-align:right;">
        <button onclick="salvarObs()">Salvar</button>
        <button onclick="fecharObs()">Fechar</button>
    </div>
</div>

<!-- Feedback -->
<div id="feedback">Operação realizada com sucesso!</div>

<!-- Delete modal -->
<div id="deleteModal" role="dialog" aria-modal="true">
    <div id="deleteModalContent">
        <p>Deseja realmente excluir esta NF?</p>
        <button id="confirmDelete" style="background:var(--primary);color:white;">Sim</button>
        <button onclick="fecharModal()" style="background:#ccc;">Cancelar</button>
    </div>
</div>

<!-- Script otimizado (mantive nomes/funções públicas para compatibilidade com atributos inline) -->
<script>
/* Globals & lightweight cache */
const webAppURL = "https://script.google.com/macros/s/AKfycbyPdj_FtFywyV4Ey4b3-Q6YV3RcgXzsEUux6ceK23cdJTh71paHQ9HMD5Ts-pFOomUX/exec";
let allData = [], workingData = [];
let currentPage = 1;
let rowsPerPage = 10;
let obsId = null, deleteId = null;

/* Cache for last filter to avoid re-filtering same term */
let lastFilterKey = '';
let cachedFiltered = [];

/* UI refs */
const refs = {
  btnForm: document.getElementById('btnForm'),
  btnView: document.getElementById('btnView'),
  btnEmails: document.getElementById('btnEmails'),
  btnManual: document.getElementById('btnManual'),
  sections: {
    form: document.getElementById('formSection'),
    view: document.getElementById('viewSection'),
    emails: document.getElementById('emailsSection')
  },
  rowsPerPage: document.getElementById('rowsPerPage'),
  filtroFabrica: document.getElementById('filtroFabrica'),
  searchInput: document.getElementById('searchInput'),
  nfTableBody: document.querySelector('#nfTable tbody'),
  pageNumbers: document.getElementById('pageNumbers'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  firstPageBtn: document.getElementById('firstPageBtn'),
  lastPageBtn: document.getElementById('lastPageBtn'),
  showingInfo: document.getElementById('showingInfo'),
  feedback: document.getElementById('feedback'),
  emailsTableBody: document.querySelector('#emailsTable tbody'),
  obsBubble: document.getElementById('obsBubble'),
  obsText: document.getElementById('obsText'),
  deleteModal: document.getElementById('deleteModal'),
  confirmDelete: document.getElementById('confirmDelete')
};

/* Navigation */
function activateButton(btn){
  [refs.btnForm, refs.btnView, refs.btnEmails, refs.btnManual].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
refs.btnForm.addEventListener('click', ()=>{ activateButton(refs.btnForm); refs.sections.form.classList.add('active'); refs.sections.view.classList.remove('active'); refs.sections.emails.classList.remove('active'); });
refs.btnView.addEventListener('click', ()=>{ activateButton(refs.btnView); refs.sections.view.classList.add('active'); refs.sections.form.classList.remove('active'); refs.sections.emails.classList.remove('active'); carregarNFs(); });
refs.btnEmails.addEventListener('click', ()=>{ activateButton(refs.btnEmails); refs.sections.emails.classList.add('active'); refs.sections.form.classList.remove('active'); refs.sections.view.classList.remove('active'); carregarEmails(); });
refs.btnManual.addEventListener('click', ()=>{ window.open("https://www.canva.com/design/DAG2E8JXyUc/AeDk2bBvcx-L8c7_t5rAiQ/edit", "_blank"); });

/* Enviar NF (mantive FileReader + POST) */
async function enviarNF(){
  const razao = document.getElementById('razao').value.trim();
  const nfVenda = document.getElementById('nfVenda').value.trim();
  const nfRemessa = document.getElementById('nfRemessa').value.trim();
  const nfCobertura = document.getElementById('nfCobertura').value.trim();
  const fabrica = document.getElementById('fabrica').value;
  const observacao = document.getElementById('observacao').value.trim();
  const arquivo = document.getElementById('arquivo').files[0];
  if(!fabrica){ alert('Selecione uma fábrica antes de enviar.'); return; }
  if(!arquivo){ alert('Anexe o arquivo PDF antes de enviar.'); return; }
  const reader = new FileReader();
  reader.onload = async () => {
    const pdfBase64 = reader.result;
    const pdfName = arquivo.name;
    const payload = { razao, nfVenda, nfRemessa, nfCobertura, fabrica, observacao, pdfBase64, pdfName };
    try{
      const res = await fetch(webAppURL, { method:'POST', body: JSON.stringify(payload)});
      const result = await res.json();
      if(result.status === 'success'){ mostrarFeedback('NF cadastrada!'); document.getElementById('nfForm').reset(); carregarNFs(); }
      else alert('Erro ao cadastrar NF.');
    }catch(e){ console.error(e); alert('Erro de conexão.'); }
  };
  reader.readAsDataURL(arquivo);
}

/* Carregar NFs do servidor */
async function carregarNFs(){
  try{
    const res = await fetch(webAppURL + '?action=get');
    allData = await res.json();
    if(!Array.isArray(allData)) allData = [];
    allData.sort((a,b)=> (new Date(b.dataHora||0) - new Date(a.dataHora||0)));
    // reset cache when data changes
    lastFilterKey = '';
    aplicarFiltroPesquisa();
  }catch(err){
    console.error(err);
    allData = [];
    aplicarFiltroPesquisa();
  }
}

/* Filtrar + pesquisar (única passagem por item) */
function aplicarFiltroPesquisa(){
  const filtro = refs.filtroFabrica.value || '';
  const termo = (refs.searchInput.value || '').toLowerCase().trim();
  const key = filtro + '|' + termo;
  if(key === lastFilterKey){
    // já temos o resultado em cachedFiltered
    workingData = cachedFiltered;
  } else {
    // filtrar em uma única passagem (redução de loops)
    const tmp = [];
    for(let i=0, L=allData.length;i<L;i++){
      const r = allData[i];
      if(filtro && String(r.fabrica || '') !== filtro) continue;
      if(!termo){ tmp.push(r); continue; }
      // busca combinada
      const combined = (String(r.razao||'') + '|' + String(r.nfVenda||'') + '|' + String(r.nfRemessa||'') + '|' + String(r.fabrica||'') + '|' + String(r.observacao||'')).toLowerCase();
      if(combined.indexOf(termo) !== -1) tmp.push(r);
    }
    cachedFiltered = tmp;
    lastFilterKey = key;
    workingData = tmp;
  }
  currentPage = 1;
  renderTabela();
}

/* Render tabela — usa DocumentFragment e só substitui tbody uma vez */
function renderTabela(){
  const tbody = refs.nfTableBody;
  // se muitos itens, só renderiza a página atual (lazy rendering)
  rowsPerPage = parseInt(refs.rowsPerPage.value,10) || 10;
  const totalItems = workingData.length;
  const totalPages = Math.max(1, Math.ceil(totalItems/rowsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*rowsPerPage;
  const end = Math.min(totalItems, start+rowsPerPage);
  const pageData = workingData.slice(start, end);

  // construir fragmento
  const frag = document.createDocumentFragment();
  if(pageData.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 9;
    td.style.textAlign = 'center';
    td.textContent = totalItems === 0 ? 'Nenhuma NF encontrada.' : 'Nenhuma NF nesta página.';
    tr.appendChild(td);
    frag.appendChild(tr);
  } else {
    for(const r of pageData){
      const hasObs = String(r.observacao || '').trim() !== '';
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.textContent = r.dataHora ? new Date(r.dataHora).toLocaleString() : '-';
      tr.appendChild(tdDate);

      const tdRaz = document.createElement('td');
      tdRaz.contentEditable = "true";
      tdRaz.onblur = function(){ atualizarCampo(r.id,'razao',this.innerText); };
      tdRaz.innerHTML = escapeHtml(r.razao || '');
      tr.appendChild(tdRaz);

      const tdVenda = document.createElement('td');
      tdVenda.contentEditable = "true";
      tdVenda.onblur = function(){ atualizarCampo(r.id,'nfVenda',this.innerText); };
      tdVenda.innerHTML = escapeHtml(r.nfVenda || '');
      tr.appendChild(tdVenda);

      const tdRem = document.createElement('td');
      tdRem.contentEditable = "true";
      tdRem.onblur = function(){ atualizarCampo(r.id,'nfRemessa',this.innerText); };
      tdRem.innerHTML = escapeHtml(r.nfRemessa || '');
      tr.appendChild(tdRem);

      const tdCob = document.createElement('td');
      tdCob.contentEditable = "true";
      tdCob.onblur = function(){ atualizarCampo(r.id,'nfCobertura',this.innerText); };
      tdCob.innerHTML = escapeHtml(r.nfCobertura || '');
      tr.appendChild(tdCob);

      const tdFab = document.createElement('td');
      tdFab.contentEditable = "true";
      tdFab.onblur = function(){ atualizarCampo(r.id,'fabrica',this.innerText); };
      tdFab.innerHTML = escapeHtml(r.fabrica || '');
      tr.appendChild(tdFab);

      const tdPdf = document.createElement('td');
      tdPdf.innerHTML = r.pdfLink ? `<a href="${r.pdfLink}" target="_blank" rel="noopener">Abrir PDF</a>` : '—';
      tr.appendChild(tdPdf);

      const tdObs = document.createElement('td');
      const obsWrap = document.createElement('div');
      obsWrap.className = 'obs-button-wrapper' + (hasObs? ' has-text': '');
      obsWrap.title = escapeHtml((r.observacao||'').split('\n')[0]||'');
      const btn = document.createElement('button');
      btn.className = 'obs-button';
      btn.textContent = '💬';
      // manter compatibilidade com abrirObs(id,this)
      btn.onclick = function(e){ abrirObs(r.id, this); };
      const span = document.createElement('span');
      span.className = 'obs-indicator';
      obsWrap.appendChild(btn);
      obsWrap.appendChild(span);
      tdObs.appendChild(obsWrap);
      tr.appendChild(tdObs);

      const tdActions = document.createElement('td');
      tdActions.className = 'actions';
      const delBtn = document.createElement('button');
      delBtn.className = 'delete';
      delBtn.textContent = '🗑️';
      delBtn.onclick = function(){ abrirModal(r.id); };
      const emailBtn = document.createElement('button');
      emailBtn.className = 'email';
      emailBtn.textContent = '✉️';
      emailBtn.onclick = function(){ enviarEmailNF(r.id); };
      tdActions.appendChild(delBtn);
      tdActions.appendChild(emailBtn);
      tr.appendChild(tdActions);

      frag.appendChild(tr);
    }
  }

  // substituir tbody de uma vez só (apêndice mínimo de operações DOM)
  tbody.innerHTML = '';
  tbody.appendChild(frag);

  updatePaginationUI(totalItems, totalPages, start+1, end);
}

/* Atualiza UI da paginação (apenas 1 operação por campo) */
function updatePaginationUI(totalItems, totalPages, startIndex = 0, endIndex = 0){
  refs.pageNumbers.innerHTML = '';
  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - Math.floor(maxButtons/2));
  let endPage = startPage + maxButtons - 1;
  if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxButtons + 1); }

  if(startPage > 1){
    const b1 = document.createElement('button'); b1.textContent = '1'; b1.onclick = ()=>goToPage(1); refs.pageNumbers.appendChild(b1);
    if(startPage > 2){ const e = document.createElement('button'); e.textContent = '...'; e.disabled = true; refs.pageNumbers.appendChild(e); }
  }
  for(let p=startPage;p<=endPage;p++){
    const b = document.createElement('button'); b.textContent = p; if(p===currentPage) b.classList.add('active'); b.onclick = ()=>goToPage(p); refs.pageNumbers.appendChild(b);
  }
  if(endPage < totalPages){
    if(endPage < totalPages -1){ const e = document.createElement('button'); e.textContent = '...'; e.disabled = true; refs.pageNumbers.appendChild(e); }
    const bl = document.createElement('button'); bl.textContent = totalPages; bl.onclick = ()=>goToPage(totalPages); refs.pageNumbers.appendChild(bl);
  }

  refs.prevBtn.disabled = currentPage <= 1;
  refs.nextBtn.disabled = currentPage >= totalPages;
  refs.firstPageBtn.disabled = currentPage <= 1;
  refs.lastPageBtn.disabled = currentPage >= totalPages;

  const info = totalItems === 0 ? 'Mostrando 0 de 0' : `Mostrando ${startIndex}–${Math.min(totalItems, endIndex)} de ${totalItems}`;
  refs.showingInfo.innerText = info;
}

/* Paginação helpers */
function changePage(dir){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = Math.min(totalPages, Math.max(1, currentPage + dir)); renderTabela(); }
function goToPage(n){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = Math.min(totalPages, Math.max(1, n)); renderTabela(); }
function goToLastPage(){ const totalPages = Math.max(1, Math.ceil(workingData.length/rowsPerPage)); currentPage = totalPages; renderTabela(); }
function changeRowsPerPage(){ rowsPerPage = parseInt(refs.rowsPerPage.value,10); currentPage = 1; renderTabela(); }

/* Observações */
function abrirObs(id, btn){
  obsId = id;
  const bubble = refs.obsBubble;
  const nf = allData.find(x=>x.id===id) || {};
  refs.obsText.value = nf.observacao || '';
  bubble.style.display = 'block';
  const rect = btn.getBoundingClientRect();
  bubble.style.left = (rect.left + window.scrollX) + 'px';
  bubble.style.top = (rect.bottom + window.scrollY + 8) + 'px';
}
function fecharObs(){ refs.obsBubble.style.display = 'none'; }
async function salvarObs(){
  const texto = refs.obsText.value;
  if(!obsId) return fecharObs();
  try{
    await fetch(`${webAppURL}?action=update&id=${obsId}&observacao=${encodeURIComponent(texto)}`);
    fecharObs(); mostrarFeedback('Observação salva!'); await carregarNFs();
  }catch(err){ console.error(err); alert('Erro ao salvar observação'); }
}

/* Delete modal */
function abrirModal(id){ deleteId = id; refs.deleteModal.style.display = 'flex'; }
function fecharModal(){ deleteId = null; refs.deleteModal.style.display = 'none'; }
refs.confirmDelete.addEventListener('click', async ()=>{
  if(!deleteId) return fecharModal();
  try{ await fetch(`${webAppURL}?action=delete&id=${deleteId}`); fecharModal(); mostrarFeedback('NF excluída!'); await carregarNFs(); }
  catch(err){ console.error(err); alert('Erro ao excluir'); }
});

/* Atualizar campo inline */
async function atualizarCampo(id, campo, valor){
  valor = String(valor || '').trim();
  try{ await fetch(`${webAppURL}?action=update&id=${id}&${campo}=${encodeURIComponent(valor)}`); }
  catch(err){ console.error(err); }
}

/* Enviar e-mail por NF */
async function enviarEmailNF(id){
  const nf = allData.find(x=>x.id===id);
  if(!nf){ alert('NF não encontrada'); return; }
  try{
    const res = await fetch(`${webAppURL}?action=getEmails&fabrica=${encodeURIComponent(nf.fabrica)}`);
    const emails = await res.json();
    if(!emails.emailPara){ alert('Nenhum e-mail cadastrado para esta fábrica!'); return; }
    const subject = `Nota de cobertura referente a nota (${nf.nfVenda||''}/${nf.nfRemessa||''}) fornecedor (${nf.razao||''}) X ${nf.fabrica||''}`;
    const body = `Nota de cobertura referente a nota (${nf.nfVenda||''}/${nf.nfRemessa||''}) fornecedor (${nf.razao||''}) X ${nf.fabrica||''}\nPDF: ${nf.pdfLink||'Não disponível'}`;
    await fetch(webAppURL, { method:'POST', body: JSON.stringify({ action:'sendEmail', to:emails.emailPara, cc:emails.emailCC, subject, body }) });
    mostrarFeedback('E-mail enviado!');
  }catch(err){ console.error(err); alert('Erro ao enviar e-mail'); }
}

/* E-mails (cadastro/listagem) */
async function salvarEmails(){
  const fabrica = document.getElementById('emailFabrica').value;
  const emailPara = document.getElementById('emailPara').value;
  if(!fabrica || !emailPara) return alert('Preencha todos os campos!');
  try{
    const res = await fetch(webAppURL, { method:'POST', body: JSON.stringify({ action:'saveEmails', fabrica, emailPara }) });
    const result = await res.json();
    if(result.status === 'success'){ mostrarFeedback('E-mail salvo!'); document.getElementById('emailsForm').reset(); carregarEmails(); }
    else alert('Erro ao salvar e-mail');
  }catch(err){ console.error(err); alert('Erro ao salvar e-mail'); }
}
async function carregarEmails(){
  try{
    const res = await fetch(webAppURL + '?action=getEmailsAll');
    const data = await res.json();
    const tbody = refs.emailsTableBody;
    tbody.innerHTML = '';
    if(!Array.isArray(data) || data.length === 0){
      const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=2; td.style.textAlign='center'; td.textContent='Nenhum e-mail cadastrado.'; tr.appendChild(td); tbody.appendChild(tr);
    } else {
      const frag = document.createDocumentFragment();
      for(const r of data){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = r.fabrica||''; const td2 = document.createElement('td'); td2.textContent = r.emailPara||'';
        tr.appendChild(td1); tr.appendChild(td2); frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }
  }catch(err){ console.error(err); }
}

/* Export CSV (mantido) */
function exportCSV(){
  const headers = ['dataHora','razao','nfVenda','nfRemessa','nfCobertura','fabrica','pdfLink','observacao'];
  const rows = [headers.join(',')];
  allData.forEach(r=>{ const line = headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(','); rows.push(line); });
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'notas_fiscais.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Feedback */
function mostrarFeedback(txt){
  const f = refs.feedback; f.innerText = txt; f.style.display = 'block';
  setTimeout(()=>{ f.style.display = 'none'; }, 2200);
}

/* util */
function escapeHtml(text){
  if(!text) return '';
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* Inicialização (evento único) */
window.addEventListener('load', ()=>{
  refs.rowsPerPage.value = refs.rowsPerPage.value || '10';
  rowsPerPage = parseInt(refs.rowsPerPage.value,10);
  // carrega NFs e emails só quando necessário: aqui pre-popular para primeira abertura
  carregarNFs();
  carregarEmails();
  // otimização adicional: manter cache e listeners já configurados (funções inline mantidas para compatibilidade)
});
</script>

</body>
</html>
